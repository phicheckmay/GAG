pcall(function() if setfpscap then setfpscap(15) end end)
repeat task.wait() until game:IsLoaded()
task.wait(1.2)

--========================
-- CONFIG (NO NAME CHECK)
--========================
local DefaultConfig = {
    ["UI_AutoRefresh"] = true,
    ["UI_RefreshSeconds"] = 3,
    ["Hotkey_ToggleUI"] = "H",
}
getgenv().MainConfig = getgenv().MainConfig or DefaultConfig
local Config = getgenv().MainConfig
for k, v in pairs(DefaultConfig) do
    if Config[k] == nil then Config[k] = v end
end

--========================
-- Services
--========================
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local LP = Players.LocalPlayer

local uiRefreshInterval = tonumber(Config["UI_RefreshSeconds"]) or 3
if uiRefreshInterval < 1 then uiRefreshInterval = 1 end
if uiRefreshInterval > 30 then uiRefreshInterval = 30 end

local autoOn = (Config["UI_AutoRefresh"] ~= false)

--========================
-- Anti-AFK
--========================
do
    local VirtualUser = game:service("VirtualUser")
    LP.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end)
end

--========================
-- Auto popup "Yes" (AUTO ACCEPT)
--========================
task.spawn(function()
    local pg = LP:WaitForChild("PlayerGui")
    local cam = workspace.CurrentCamera

    local ok, lbl = pcall(function()
        return pg:WaitForChild("Prompt")
            :FindFirstChild("Blackout")
            :FindFirstChild("Options")
            :FindFirstChild("Yes")
            :FindFirstChild("Label")
    end)
    if not ok or not lbl then
        warn("[MAIN] Kh√¥ng t√¨m th·∫•y Prompt/Yes UI ƒë·ªÉ auto accept.")
        return
    end

    local function fireBindable()
        if not getnilinstances then return end
        for _, obj in ipairs(getnilinstances()) do
            if obj:IsA("BindableEvent") then
                pcall(function() obj:Fire(true) end)
            end
        end
    end

    lbl:GetPropertyChangedSignal("Text"):Connect(function()
        if lbl.Text == "Yes" then
            local cf, ct = cam.CFrame, cam.CameraType
            cam.CameraType = Enum.CameraType.Scriptable
            task.wait(0.25)
            fireBindable()
            task.wait(0.25)
            cam.CameraType = ct
            cam.CFrame = cf
        end
    end)
end)

--========================
-- Dependencies (inventory)
--========================
local ItemUtil = require(RS.Shared.ItemUtility)
local ReplionClient = require(RS.Packages.Replion).Client
local Data = ReplionClient:WaitReplion("Data")

local function rawItems()
    return Data:Get({ "Inventory", "Items" }) or {}
end

local function scanCounts()
    local counts, total = {}, 0
    for _, v in pairs(rawItems()) do
        local ok, base = pcall(function()
            return ItemUtil:GetItemData(v.Id)
        end)
        local name = ok and base and base.Data and base.Data.Name
        if name then
            counts[name] = (counts[name] or 0) + 1
            total += 1
        end
    end
    return counts, total
end

local function sortedList(counts)
    local list = {}
    for name, count in pairs(counts) do
        list[#list+1] = { name = name, count = count }
    end
    table.sort(list, function(a, b)
        if a.count == b.count then return a.name < b.name end
        return a.count > b.count
    end)
    return list
end

local function keycodeFromString(s)
    if typeof(s) ~= "string" then return Enum.KeyCode.H end
    local map = {
        RightShift = Enum.KeyCode.RightShift,
        LeftShift = Enum.KeyCode.LeftShift,
        RightControl = Enum.KeyCode.RightControl,
        LeftControl = Enum.KeyCode.LeftControl,
        RightAlt = Enum.KeyCode.RightAlt,
        LeftAlt = Enum.KeyCode.LeftAlt,
    }
    if map[s] then return map[s] end
    return Enum.KeyCode[s] or Enum.KeyCode.H
end
local TOGGLE_KEY = keycodeFromString(Config["Hotkey_ToggleUI"])

--========================
-- MAIN UI (FIXED ALL)
--========================
local function buildMainUI()
    local pg = LP:WaitForChild("PlayerGui")

    -- cleanup old UI + old heartbeat connection
    if getgenv().__MAIN_UI_CONN then
        pcall(function() getgenv().__MAIN_UI_CONN:Disconnect() end)
        getgenv().__MAIN_UI_CONN = nil
    end
    do
        local old = pg:FindFirstChild("MAIN_PRETTY_UI"); if old then old:Destroy() end
        local old2 = pg:FindFirstChild("MAIN_PRETTY_UI_MINI"); if old2 then old2:Destroy() end
    end

    local function corner(parent, r)
        local c = Instance.new("UICorner")
        c.CornerRadius = UDim.new(0, r or 14)
        c.Parent = parent
        return c
    end

    local function stroke(parent, thickness, transp)
        local s = Instance.new("UIStroke")
        s.Thickness = thickness or 2
        s.Transparency = transp or 0.85
        s.Color = Color3.fromRGB(0, 0, 0)
        s.Parent = parent
        return s
    end

    local function shadow(parent, z)
        local img = Instance.new("ImageLabel")
        img.Name = "Shadow"
        img.Parent = parent
        img.AnchorPoint = Vector2.new(0.5, 0.5)
        img.Position = UDim2.fromScale(0.5, 0.5)
        img.Size = UDim2.new(1, 84, 1, 84)
        img.BackgroundTransparency = 1
        img.ImageTransparency = 0.62
        img.Image = "rbxassetid://1316045217"
        img.ScaleType = Enum.ScaleType.Slice
        img.SliceCenter = Rect.new(10, 10, 118, 118)
        img.ZIndex = z or 0
        return img
    end

    local function mkGradient(btn, c1, c2)
        local g = btn:FindFirstChild("G") or Instance.new("UIGradient")
        g.Name = "G"
        g.Rotation = 0
        g.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, c1),
            ColorSequenceKeypoint.new(1, c2),
        })
        g.Parent = btn
        return g
    end

    local function tween(obj, props, t)
        TweenService:Create(obj, TweenInfo.new(t or 0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
    end

    local function mkBtn(parent, text, w, h)
        local b = Instance.new("TextButton")
        b.Parent = parent
        b.Size = UDim2.fromOffset(w or 150, h or 38)
        b.BackgroundColor3 = Color3.fromRGB(245, 248, 255)
        b.BorderSizePixel = 0
        b.Text = text
        b.Font = Enum.Font.GothamBlack
        b.TextSize = 16
        b.TextColor3 = Color3.fromRGB(20, 30, 45)
        b.AutoButtonColor = false
        corner(b, 14)
        local st = stroke(b, 2, 0.92)

        -- hover/press effect without breaking gradient:
        b.MouseEnter:Connect(function()
            tween(st, {Transparency = 0.86}, 0.10)
            tween(b, {BackgroundTransparency = 0.00}, 0.10)
        end)
        b.MouseLeave:Connect(function()
            tween(st, {Transparency = 0.92}, 0.10)
            tween(b, {BackgroundTransparency = 0.00}, 0.10)
        end)
        b.MouseButton1Down:Connect(function()
            tween(b, {Size = UDim2.fromOffset((w or 150) - 2, (h or 38) - 2)}, 0.06)
        end)
        b.MouseButton1Up:Connect(function()
            tween(b, {Size = UDim2.fromOffset(w or 150, h or 38)}, 0.08)
        end)

        return b
    end

    local function paintBtn(b, mode)
        -- remove old gradient if needed
        local oldG = b:FindFirstChild("G")
        if oldG then oldG:Destroy() end

        if mode == "BLUE" then
            b.TextColor3 = Color3.fromRGB(255,255,255)
            b.BackgroundColor3 = Color3.fromRGB(90,160,255)
            mkGradient(b, Color3.fromRGB(90,160,255), Color3.fromRGB(200,120,255))
            local s = b:FindFirstChildOfClass("UIStroke"); if s then s.Transparency = 0.90 end
            return
        end

        if mode == "GREEN" then
            b.TextColor3 = Color3.fromRGB(255,255,255)
            b.BackgroundColor3 = Color3.fromRGB(40, 200, 120)
            mkGradient(b, Color3.fromRGB(40,200,120), Color3.fromRGB(120,220,170))
            local s = b:FindFirstChildOfClass("UIStroke"); if s then s.Transparency = 0.92 end
            return
        end

        if mode == "RED" then
            b.TextColor3 = Color3.fromRGB(255,255,255)
            b.BackgroundColor3 = Color3.fromRGB(230, 80, 80)
            mkGradient(b, Color3.fromRGB(230,80,80), Color3.fromRGB(255,140,140))
            local s = b:FindFirstChildOfClass("UIStroke"); if s then s.Transparency = 0.92 end
            return
        end

        -- GRAY
        b.TextColor3 = Color3.fromRGB(20,30,45)
        b.BackgroundColor3 = Color3.fromRGB(245,248,255)
        local s = b:FindFirstChildOfClass("UIStroke"); if s then s.Transparency = 0.92 end
    end

    -- MAIN GUI
    local gui = Instance.new("ScreenGui")
    gui.Name = "MAIN_PRETTY_UI"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.Parent = pg

    local root = Instance.new("Frame")
    root.Parent = gui
    root.AnchorPoint = Vector2.new(0.5, 0.5)
    root.Position = UDim2.fromScale(0.5, 0.5)
    root.Size = UDim2.fromOffset(860, 560)
    root.BorderSizePixel = 0
    root.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    root.BackgroundTransparency = 0.02
    root.ZIndex = 10
    corner(root, 26)
    stroke(root, 2, 0.82)
    shadow(root, 9)

    local bgGrad = Instance.new("UIGradient")
    bgGrad.Rotation = 90
    bgGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(245, 248, 255)),
    })
    bgGrad.Parent = root

    local pad = Instance.new("UIPadding")
    pad.Parent = root
    pad.PaddingLeft = UDim.new(0, 26)
    pad.PaddingRight = UDim.new(0, 26)
    pad.PaddingTop = UDim.new(0, 22)
    pad.PaddingBottom = UDim.new(0, 20)

    -- HEADER
    local headerWrap = Instance.new("Frame")
    headerWrap.Parent = root
    headerWrap.BorderSizePixel = 0
    headerWrap.Size = UDim2.new(1, 0, 0, 90)
    headerWrap.BackgroundColor3 = Color3.fromRGB(240, 245, 255)
    headerWrap.ZIndex = 11
    corner(headerWrap, 20)
    stroke(headerWrap, 2, 0.88)

    local hGrad = Instance.new("UIGradient")
    hGrad.Rotation = 0
    hGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(90, 160, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 120, 255)),
    })
    hGrad.Parent = headerWrap

    local hOverlay = Instance.new("Frame")
    hOverlay.Parent = headerWrap
    hOverlay.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    hOverlay.BackgroundTransparency = 0.18
    hOverlay.BorderSizePixel = 0
    hOverlay.Size = UDim2.new(1, 0, 1, 0)
    hOverlay.ZIndex = 12
    corner(hOverlay, 20)

    local title = Instance.new("TextLabel")
    title.Parent = headerWrap
    title.BackgroundTransparency = 1
    title.Position = UDim2.fromOffset(18, 12)
    title.Size = UDim2.new(1, -260, 0, 38)
    title.Font = Enum.Font.GothamBlack
    title.TextSize = 30
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = Color3.fromRGB(18, 18, 28)
    title.Text = ("INVENTORY SCANNER ‚Ä¢ %s"):format(LP.Name)
    title.ZIndex = 13

    local subtitle = Instance.new("TextLabel")
    subtitle.Parent = headerWrap
    subtitle.BackgroundTransparency = 1
    subtitle.Position = UDim2.fromOffset(18, 54)
    subtitle.Size = UDim2.new(1, -260, 0, 24)
    subtitle.Font = Enum.Font.GothamBold
    subtitle.TextSize = 16
    subtitle.TextXAlignment = Enum.TextXAlignment.Left
    subtitle.TextColor3 = Color3.fromRGB(40, 55, 85)
    subtitle.Text = ("AutoRefresh: %ss | Hotkey: %s"):format(tostring(uiRefreshInterval), tostring(Config["Hotkey_ToggleUI"]))
    subtitle.ZIndex = 13

    local btnWrap = Instance.new("Frame")
    btnWrap.Parent = headerWrap
    btnWrap.BackgroundTransparency = 1
    btnWrap.AnchorPoint = Vector2.new(1, 0.5)
    btnWrap.Position = UDim2.new(1, -14, 0.5, 0)
    btnWrap.Size = UDim2.fromOffset(240, 44)
    btnWrap.ZIndex = 13

    local btnLayout = Instance.new("UIListLayout")
    btnLayout.Parent = btnWrap
    btnLayout.FillDirection = Enum.FillDirection.Horizontal
    btnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    btnLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    btnLayout.Padding = UDim.new(0, 10)

    local minBtn = mkBtn(btnWrap, "MIN", 84, 38)
    paintBtn(minBtn, "GRAY")

    local closeBtn = mkBtn(btnWrap, "CLOSE", 120, 38)
    paintBtn(closeBtn, "RED")

    -- MINI GUI
    local miniGui = Instance.new("ScreenGui")
    miniGui.Name = "MAIN_PRETTY_UI_MINI"
    miniGui.ResetOnSpawn = false
    miniGui.IgnoreGuiInset = true
    miniGui.Parent = pg

    local miniBtn = Instance.new("TextButton")
    miniBtn.Parent = miniGui
    miniBtn.Position = UDim2.fromOffset(18, 140)
    miniBtn.Size = UDim2.fromOffset(56, 56)
    miniBtn.Text = "üêü"
    miniBtn.Font = Enum.Font.GothamBlack
    miniBtn.TextSize = 22
    miniBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    miniBtn.TextColor3 = Color3.fromRGB(20, 30, 45)
    miniBtn.BorderSizePixel = 0
    miniBtn.Visible = false
    miniBtn.ZIndex = 999
    corner(miniBtn, 18)
    stroke(miniBtn, 2, 0.88)
    shadow(miniBtn, 998)

    do
        local dragging = false
        local dragStart, startPos
        miniBtn.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = miniBtn.Position
            end
        end)
        miniBtn.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
        end)
        UIS.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                miniBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    local uiVisible = true
    local function setUIVisible(state)
        uiVisible = state
        root.Visible = uiVisible
        miniBtn.Visible = not uiVisible
    end

    -- CONTENT
    local content = Instance.new("Frame")
    content.Parent = root
    content.BackgroundTransparency = 1
    content.Position = UDim2.fromOffset(0, 102)
    content.Size = UDim2.new(1, 0, 1, -102)
    content.ZIndex = 11

    local controls = Instance.new("Frame")
    controls.Parent = content
    controls.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    controls.BorderSizePixel = 0
    controls.Size = UDim2.new(1, 0, 0, 62)
    controls.ZIndex = 11
    corner(controls, 18)
    stroke(controls, 2, 0.9)

    local cPad = Instance.new("UIPadding")
    cPad.Parent = controls
    cPad.PaddingLeft = UDim.new(0, 16)
    cPad.PaddingRight = UDim.new(0, 16)
    cPad.PaddingTop = UDim.new(0, 12)
    cPad.PaddingBottom = UDim.new(0, 12)

    local refreshBtn = mkBtn(controls, "REFRESH", 150, 40)
    paintBtn(refreshBtn, "BLUE")

    local pauseBtn = mkBtn(controls, "AUTO: ?", 170, 40)
    pauseBtn.Position = UDim2.fromOffset(160, 0)

    local function paintAuto()
        if autoOn then paintBtn(pauseBtn, "GREEN") else paintBtn(pauseBtn, "RED") end
        pauseBtn.Text = autoOn and "AUTO: ON" or "AUTO: OFF"
    end
    paintAuto()

    local intervalBox = Instance.new("TextBox")
    intervalBox.Parent = controls
    intervalBox.Size = UDim2.fromOffset(110, 40)
    intervalBox.Position = UDim2.fromOffset(340, 0)
    intervalBox.Text = tostring(uiRefreshInterval)
    intervalBox.ClearTextOnFocus = false
    intervalBox.Font = Enum.Font.GothamBlack
    intervalBox.TextSize = 16
    intervalBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    intervalBox.TextColor3 = Color3.fromRGB(20, 30, 45)
    intervalBox.BorderSizePixel = 0
    intervalBox.ZIndex = 12
    corner(intervalBox, 14)
    local intervalStroke = stroke(intervalBox, 2, 0.9)

    local intervalLbl = Instance.new("TextLabel")
    intervalLbl.Parent = controls
    intervalLbl.BackgroundTransparency = 1
    intervalLbl.Position = UDim2.fromOffset(458, 0)
    intervalLbl.Size = UDim2.fromOffset(110, 40)
    intervalLbl.Font = Enum.Font.GothamBold
    intervalLbl.TextSize = 16
    intervalLbl.TextXAlignment = Enum.TextXAlignment.Left
    intervalLbl.TextColor3 = Color3.fromRGB(45, 60, 85)
    intervalLbl.Text = "seconds"
    intervalLbl.ZIndex = 12

    local search = Instance.new("TextBox")
    search.Parent = controls
    search.AnchorPoint = Vector2.new(1, 0)
    search.Position = UDim2.new(1, 0, 0, 0)
    search.Size = UDim2.fromOffset(280, 40)
    search.PlaceholderText = "Search item name..."
    search.Text = ""
    search.ClearTextOnFocus = false
    search.Font = Enum.Font.GothamBold
    search.TextSize = 16
    search.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    search.TextColor3 = Color3.fromRGB(20, 30, 45)
    search.BorderSizePixel = 0
    search.ZIndex = 12
    corner(search, 14)
    local searchStroke = stroke(search, 2, 0.9)

    local function setFocusStroke(s, on)
        s.Transparency = on and 0.75 or 0.9
        s.Thickness = on and 3 or 2
    end
    search.Focused:Connect(function() setFocusStroke(searchStroke, true) end)
    search.FocusLost:Connect(function() setFocusStroke(searchStroke, false) end)
    intervalBox.Focused:Connect(function() setFocusStroke(intervalStroke, true) end)
    intervalBox.FocusLost:Connect(function() setFocusStroke(intervalStroke, false) end)

    local stats = Instance.new("TextLabel")
    stats.Parent = content
    stats.BackgroundTransparency = 1
    stats.Position = UDim2.fromOffset(0, 74)
    stats.Size = UDim2.new(1, 0, 0, 24)
    stats.Font = Enum.Font.GothamBlack
    stats.TextSize = 16
    stats.TextXAlignment = Enum.TextXAlignment.Left
    stats.TextColor3 = Color3.fromRGB(45, 60, 85)
    stats.Text = "Total: - | Unique: - | Last: -"
    stats.ZIndex = 11

    local listCard = Instance.new("Frame")
    listCard.Parent = content
    listCard.Position = UDim2.fromOffset(0, 108)
    listCard.Size = UDim2.new(1, 0, 1, -108)
    listCard.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    listCard.BorderSizePixel = 0
    listCard.ZIndex = 11
    corner(listCard, 18)
    stroke(listCard, 2, 0.9)

    local scrolling = Instance.new("ScrollingFrame")
    scrolling.Parent = listCard
    scrolling.Position = UDim2.fromOffset(14, 14)
    scrolling.Size = UDim2.new(1, -28, 1, -28)
    scrolling.BackgroundTransparency = 1
    scrolling.BorderSizePixel = 0
    scrolling.ScrollBarThickness = 8
    scrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
    scrolling.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrolling.ZIndex = 12

    local layout = Instance.new("UIListLayout")
    layout.Parent = scrolling
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 10)

    local function clearRows()
        for _, ch in ipairs(scrolling:GetChildren()) do
            if ch:IsA("Frame") then ch:Destroy() end
        end
    end

    local function addRow(name, count)
        local row = Instance.new("Frame")
        row.Parent = scrolling
        row.Size = UDim2.new(1, 0, 0, 54)
        row.BackgroundColor3 = Color3.fromRGB(246, 249, 255)
        row.BorderSizePixel = 0
        row.ZIndex = 12
        corner(row, 16)
        stroke(row, 2, 0.93)

        local bar = Instance.new("Frame")
        bar.Parent = row
        bar.Size = UDim2.fromOffset(8, 54)
        bar.BackgroundColor3 = Color3.fromRGB(90, 160, 255)
        bar.BorderSizePixel = 0
        bar.ZIndex = 13
        corner(bar, 16)
        local barGrad = Instance.new("UIGradient", bar)
        barGrad.Rotation = 90
        barGrad.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(90, 160, 255)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 120, 255)),
        })

        local nameLbl = Instance.new("TextLabel")
        nameLbl.Parent = row
        nameLbl.BackgroundTransparency = 1
        nameLbl.Position = UDim2.fromOffset(18, 0)
        nameLbl.Size = UDim2.new(1, -180, 1, 0)
        nameLbl.Font = Enum.Font.GothamBlack
        nameLbl.TextSize = 18
        nameLbl.TextXAlignment = Enum.TextXAlignment.Left
        nameLbl.TextColor3 = Color3.fromRGB(20, 30, 45)
        nameLbl.TextTruncate = Enum.TextTruncate.AtEnd
        nameLbl.Text = name
        nameLbl.ZIndex = 13

        local countLbl = Instance.new("TextLabel")
        countLbl.Parent = row
        countLbl.BackgroundTransparency = 1
        countLbl.AnchorPoint = Vector2.new(1, 0.5)
        countLbl.Position = UDim2.new(1, -14, 0.5, 0)
        countLbl.Size = UDim2.fromOffset(160, 42)
        countLbl.Font = Enum.Font.GothamBlack
        countLbl.TextSize = 18
        countLbl.TextXAlignment = Enum.TextXAlignment.Right
        countLbl.TextColor3 = Color3.fromRGB(40, 90, 160)
        countLbl.Text = "x" .. tostring(count)
        countLbl.ZIndex = 13
    end

    local lastCounts = {}
    local accumulator = 0

    local function nowTimeString()
        local t = os.date("*t")
        return string.format("%02d:%02d:%02d", t.hour, t.min, t.sec)
    end

    local function render(filterText)
        filterText = (filterText or ""):lower()
        clearRows()
        for _, it in ipairs(sortedList(lastCounts)) do
            if filterText == "" or it.name:lower():find(filterText, 1, true) then
                addRow(it.name, it.count)
            end
        end
    end

    local function doRefresh()
        local counts, total = scanCounts()
        lastCounts = counts
        local unique = 0
        for _ in pairs(counts) do unique += 1 end
        stats.Text = string.format("Total: %d | Unique: %d | Last: %s", total, unique, nowTimeString())
        render(search.Text)
    end

    refreshBtn.MouseButton1Click:Connect(function() pcall(doRefresh) end)

    pauseBtn.MouseButton1Click:Connect(function()
        autoOn = not autoOn
        paintAuto()
    end)

    intervalBox.FocusLost:Connect(function()
        local n = tonumber(intervalBox.Text)
        if not n then intervalBox.Text = tostring(uiRefreshInterval); return end
        if n < 1 then n = 1 end
        if n > 30 then n = 30 end
        uiRefreshInterval = n
        intervalBox.Text = tostring(n)
        subtitle.Text = ("AutoRefresh: %ss | Hotkey: %s"):format(tostring(uiRefreshInterval), tostring(Config["Hotkey_ToggleUI"]))
    end)

    search:GetPropertyChangedSignal("Text"):Connect(function()
        render(search.Text)
    end)

    minBtn.MouseButton1Click:Connect(function() setUIVisible(false) end)
    miniBtn.MouseButton1Click:Connect(function() setUIVisible(true) end)
    closeBtn.MouseButton1Click:Connect(function()
        gui:Destroy()
        miniGui:Destroy()
        if getgenv().__MAIN_UI_CONN then
            pcall(function() getgenv().__MAIN_UI_CONN:Disconnect() end)
            getgenv().__MAIN_UI_CONN = nil
        end
    end)

    -- drag by header
    do
        local dragging = false
        local dragStart, startPos
        headerWrap.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = root.Position
            end
        end)
        headerWrap.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
        end)
        UIS.InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                root.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    -- hotkey toggle (state-safe)
    UIS.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == TOGGLE_KEY then
            setUIVisible(not uiVisible)
        end
    end)

    -- heartbeat (store to disconnect later)
    getgenv().__MAIN_UI_CONN = RunService.Heartbeat:Connect(function(dt)
        if not autoOn then return end
        accumulator += dt
        if accumulator >= uiRefreshInterval then
            accumulator = 0
            pcall(doRefresh)
        end
    end)

    pcall(doRefresh)
end

buildMainUI()
