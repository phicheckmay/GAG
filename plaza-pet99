--// ================== CONFIG ================== \\--

local CONFIG = {
    TARGET_NAME  = "Huge Blue Lucky Block", -- Tên pet đúng như trong inventory
    TARGET_CLASS = "Pet",                   -- Class (pet): "Pet"
    PRICE        = 15_000_000,              -- 15m diamonds
    MAX_SLOTS    = 25,                      -- Full 25 slot booth
    PER_LIST     = 1,                       -- Mỗi listing bán 1 con
    LOOP_DELAY   = 3,                     -- Delay giữa mỗi lần list (giây)
}

--// ============= KHÔNG SỬA DƯỚI NẾU KHÔNG RÕ ============= \\--

-- PS99 SELL 1 PET – SIMPLE
if not game:IsLoaded() then game.Loaded:Wait() end

local PS99 = {Pro = 15588442388, Normal = 15502339080}
if not table.find({PS99.Normal, PS99.Pro}, game.PlaceId) then
    warn("[Simple Seller]: Chỉ dùng trong Trading Plaza Pet Simulator 99.")
    return
end

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer       = Players.LocalPlayer

repeat task.wait() until LocalPlayer and LocalPlayer.GetAttribute and LocalPlayer:GetAttribute("__LOADED")
if not LocalPlayer.Character then LocalPlayer.CharacterAdded:Wait() end
local HumanoidRootPart = LocalPlayer.Character:WaitForChild("HumanoidRootPart")

local TARGET_NAME  = CONFIG.TARGET_NAME
local TARGET_CLASS = CONFIG.TARGET_CLASS
local PRICE        = CONFIG.PRICE
local MAX_SLOTS    = CONFIG.MAX_SLOTS
local PER_LIST     = CONFIG.PER_LIST
local LOOP_DELAY   = CONFIG.LOOP_DELAY

-- Lấy Library
local NLibrary = ReplicatedStorage:WaitForChild("Library")

local function LoadModules(Path, LoadTable)
    for _,v in next, Path:GetChildren() do
        if v:IsA("ModuleScript") and not v:GetAttribute("NOLOAD") then
            local ok, m = pcall(require, v)
            if ok then
                LoadTable[v.Name] = m
            end
        end
    end
end

if not getgenv().Library then
    getgenv().Library = {}
    LoadModules(NLibrary.Client, getgenv().Library)
    LoadModules(NLibrary, getgenv().Library)
end

local Library    = getgenv().Library
local PlayerSave = require(NLibrary.Client.Save)

-- Lấy state booth (chỉ những gì cần thiết)
local Booths, ClaimedBooths, BoothsInteractive do
    local boothScript = NLibrary.Client:FindFirstChild("BoothCmds") 
        or LocalPlayer.PlayerScripts.Scripts.Game["Trading Plaza"]["Booths Frontend"]

    -- lấy Booths
    repeat
        task.wait()
        local getState = getsenv(boothScript).getState
        if getState then
            Booths = getupvalues(getState)
        end
    until Booths

    -- lấy ClaimedBooths & BoothsInteractive
    repeat
        task.wait()
        local updateAllInteracts = getsenv(boothScript).updateAllInteracts
        if updateAllInteracts then
            local ups = getupvalues(updateAllInteracts)
            ClaimedBooths     = ups[1]
            BoothsInteractive = ups[3]
        end
    until ClaimedBooths and BoothsInteractive
end

-- Claim booth đẹp
local function IsBoothAvailable(BoothID)
    for _, BoothTable in pairs(ClaimedBooths) do
        if BoothTable.BoothID == BoothID then
            return false
        end
    end
    return true
end

local function GetCenterX()
    local minX, maxX = math.huge, -math.huge
    for _, BoothModel in pairs(BoothsInteractive) do
        local x = BoothModel.Pets.Position.X
        if x < minX then minX = x end
        if x > maxX then maxX = x end
    end
    return (minX + maxX) / 2
end

local function GetBoothPriority(BoothModel, CenterX)
    local yPriority = BoothModel.Pets.Position.Y
    local xDistance = math.abs(BoothModel.Pets.Position.X - CenterX)
    return yPriority, xDistance
end

local function ClaimOptimalBooth()
    -- Nếu đã có booth rồi thì không claim nữa
    if ClaimedBooths[LocalPlayer] then
        warn("[Simple Seller]: Đã có booth, bỏ qua claim.")
        return true
    end

    local BoothCandidates = {}
    local CenterX = GetCenterX()

    for BoothID, BoothModel in next, BoothsInteractive do
        if ClaimedBooths[LocalPlayer] then return true end
        if IsBoothAvailable(BoothID) then
            local yPriority, xDistance = GetBoothPriority(BoothModel, CenterX)
            table.insert(BoothCandidates, {
                BoothID   = BoothID,
                Model     = BoothModel,
                Y         = yPriority,
                xDistance = xDistance,
            })
        end
    end

    table.sort(BoothCandidates, function(a, b)
        if a.Y == b.Y then
            return a.xDistance < b.xDistance
        end
        return a.Y < b.Y
    end)

    for _, Booth in next, BoothCandidates do
        local Success = Library.Network.Invoke("Booths_ClaimBooth", Booth.BoothID)
        if Success then
            local Interact = Booth.Model:WaitForChild("Interact", 7)
            if Interact then
                Library.Network.Fire("Hoverboard_RequestUnequip")
                task.wait(1)
                HumanoidRootPart.CFrame =
                    Interact.CFrame * CFrame.new(0,-2,-6) * CFrame.Angles(0, math.rad(180), 0)
            end
            warn("[Simple Seller]: Claim booth thành công.")
            return true
        end
    end

    warn("[Simple Seller]: Không claim được booth nào.")
    return false
end

-- Đếm số slot đang dùng trong booth của mình
local function GetUsedSlots()
    local BoothCount = 0

    for _, Users in next, Booths do
        for Username, Booth in next, Users do
            for BoothInfo, InfoValues in next, Booth do
                if BoothInfo == "Listings" and tostring(Username):find(LocalPlayer.Name) then
                    for _, _ in next, InfoValues do
                        BoothCount = BoothCount + 1
                    end
                    return BoothCount
                end
            end
        end
    end

    return 0
end

-- Tìm pet trong inventory
local function FindTargetPet()
    local invState = Library.InventoryCmds.State()
    local container = invState.container
    if not container or not container._store or not container._store._byType then
        warn("[Simple Seller]: Không đọc được inventory.")
        return
    end

    local pets = container._store._byType[TARGET_CLASS]
    if not pets or not pets._byUID then
        warn("[Simple Seller]: Không đọc được inventory "..tostring(TARGET_CLASS)..".")
        return
    end

    for uid, item in pairs(pets._byUID) do
        local data   = item._data
        local id     = item.GetId and item:GetId() or data and data.id
        local locked = data and data._lk
        local amount = data and (data._am or 1) or 1
        if id == TARGET_NAME and not locked then
            return uid, amount
        end
    end
end

-- Logic chính
task.spawn(function()
    -- 1) Claim booth nếu chưa có, nếu có rồi thì dùng luôn
    ClaimOptimalBooth()
    repeat task.wait() until ClaimedBooths[LocalPlayer]
    warn("[Simple Seller]: Booth sẵn sàng, bắt đầu list...")

    while true do
        -- 2) Check số slot hiện tại
        local usedSlots = GetUsedSlots()
        if usedSlots >= MAX_SLOTS then
            warn(string.format("[Simple Seller]: Booth full %d/%d slot, dừng.", usedSlots, MAX_SLOTS))
            break
        end

        -- 3) Tìm pet trong túi
        local uid, amount = FindTargetPet()
        if not uid then
            warn("[Simple Seller]: Hết pet '"..TARGET_NAME.."' để bán, dừng.")
            break
        end

        local toSell = math.min(PER_LIST, amount)
        warn(string.format("[Simple Seller]: List '%s' x%d @ %d | slot: %d/%d",
            TARGET_NAME, toSell, PRICE, usedSlots, MAX_SLOTS))

        -- 4) Gửi request list
        local ok = Library.Network.Invoke("Booths_CreateListing", uid, PRICE, toSell)
        if not ok then
            warn("[Simple Seller]: Lỗi khi list pet, thử lại sau.")
            task.wait(3)
        else
            -- cho game cập nhật booth
            task.wait(1.5)
        end

        task.wait(LOOP_DELAY)
    end

    warn("[Simple Seller]: Hoàn thành vòng list.")
end)
