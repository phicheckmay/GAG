--====================================================
-- âœ… PHIÃŠN Báº¢N 3.3: FULL SCRIPT (UI LOG + AUTO GIFT + KICK 267)
--====================================================
repeat task.wait() until game:IsLoaded()

local Players            = game:GetService("Players")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local lp                 = Players.LocalPlayer
local HRP                = lp.Character and lp.Character:WaitForChild("HumanoidRootPart")
local Remotes            = ReplicatedStorage:WaitForChild("Remotes")

-- ğŸŒ± Config
local PLANT_NAME    = (getgenv().PLANT_NAME    or "Mango")
local TARGET_PLAYER = (getgenv().TARGET_PLAYER or "Phingoc223")

task.wait(3)

--====================================================
-- âœ… UI LOG (ná»n Ä‘en Ä‘áº·c, hiá»ƒn thá»‹ tá»‘i Ä‘a 6 dÃ²ng)
--====================================================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "StatusHUD"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = lp:WaitForChild("PlayerGui")

local Panel = Instance.new("Frame")
Panel.Parent = ScreenGui
Panel.Size = UDim2.fromOffset(600, 400)
Panel.Position = UDim2.new(0.5, -300, 0.5, -200)
Panel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Panel.BackgroundTransparency = 0
Panel.BorderSizePixel = 0

local LogBox = Instance.new("TextLabel")
LogBox.Parent = Panel
LogBox.Size = UDim2.fromScale(1, 1)
LogBox.BackgroundTransparency = 1
LogBox.TextColor3 = Color3.fromRGB(255, 255, 255)
LogBox.TextStrokeTransparency = 0.5
LogBox.TextScaled = false
LogBox.Font = Enum.Font.GothamMedium
LogBox.TextXAlignment = Enum.TextXAlignment.Left
LogBox.TextYAlignment = Enum.TextYAlignment.Top
LogBox.TextSize = 18
LogBox.Text = "[UI] Khá»Ÿi Ä‘á»™ng log...\n"

local logLines = {}
local function uiStatus(msg)
	table.insert(logLines, os.date("[%H:%M:%S] ") .. msg)
	if #logLines > 6 then table.remove(logLines, 1) end
	LogBox.Text = table.concat(logLines, "\n")
	print(msg)
end

uiStatus("Khá»Ÿi Ä‘á»™ng UI log...")

--====================================================
-- âœ… PHáº¦N 2: HÃ€M TIá»†N ÃCH
--====================================================
local function baseName(str)
	str = tostring(str or "")
	str = str:gsub("%b[]", ""):gsub("%b()", "")
	str = str:gsub("%d+[%.,]?%d*%s*kg", "")
	str = str:gsub("%s+", " "):gsub("^%s+", ""):gsub("%s+$", "")
	return str:lower()
end

local TARGET_BASE = baseName(PLANT_NAME)

local function findPlantInBackpack()
	local bp = lp:FindFirstChild("Backpack")
	if not bp then return nil end
	for _, item in ipairs(bp:GetChildren()) do
		if item:IsA("Tool") and baseName(item.Name) == TARGET_BASE then
			return item
		end
	end
end

local function findPlantOnHand()
	local char = lp.Character
	if not char then return nil end
	for _, tool in ipairs(char:GetChildren()) do
		if tool:IsA("Tool") and baseName(tool.Name) == TARGET_BASE then
			return tool
		end
	end
end

local function stillHasPlant()
	return findPlantInBackpack() or findPlantOnHand()
end

--====================================================
-- âœ… PHáº¦N 3: UNLOCK TIM â¤ï¸
--====================================================
local function unlockAllMatchingPlants()
	local favRemote = Remotes:FindFirstChild("FavoriteItem")
	if not favRemote then
		uiStatus("âŒ KhÃ´ng tÃ¬m tháº¥y FavoriteItem remote!")
		return
	end

	local FavoritesTable
	for _, v in ipairs(getgc(true)) do
		if typeof(v) == "table" and rawget(v, "Favorites") then
			FavoritesTable = rawget(v, "Favorites")
			break
		end
	end
	if not FavoritesTable then
		uiStatus("âš ï¸ KhÃ´ng tÃ¬m tháº¥y báº£ng Favorites!")
		return
	end

	local count = 0
	for uuid in pairs(FavoritesTable) do
		if typeof(uuid) == "string" and uuid:match("%x+%-%x+%-%x+%-%x+%-%x+") then
			favRemote:FireServer(uuid)
			count += 1
			task.wait(0.05)
		end
	end
	uiStatus(("âœ… Bá» tim %d pet trong tÃºi!"):format(count))
end

--====================================================
-- âœ… PHáº¦N 4: AUTOSELL + SELL ALL
--====================================================
local AutoSellRemote = Remotes:FindFirstChild("AutoSell")
local SellAllRemote  = Remotes:FindFirstChild("ItemSell")

local function setupAutoSell()
	if not AutoSellRemote then return uiStatus("âŒ Thiáº¿u Remote AutoSell!") end

	local tbl
	for _, v in ipairs(getgc(true)) do
		if typeof(v) == "table" and rawget(v, "AutoSell") then
			tbl = v.AutoSell
			break
		end
	end
	if not tbl then return uiStatus("âš ï¸ KhÃ´ng tÃ¬m tháº¥y AutoSell table!") end

	local cfg = {
		Normal = true, Rare = true, Epic = true, Legendary = true,
		Mythic = true, Secret = true, Godly = true,
	}
	for rarity, wantGray in pairs(cfg) do
		for i = 1, 3 do
			local v = tbl[rarity]
			if (v == 1 or v == true) == wantGray then break end
			AutoSellRemote:FireServer(rarity)
			task.wait(0.1)
		end
	end
	uiStatus("ğŸ¯ AUTOSELL: Ä‘Ã£ set táº¥t cáº£ sang GRAY")
end

local function sellAllNow()
	if SellAllRemote then
		SellAllRemote:FireServer(nil, nil, true)
		uiStatus("ğŸ’° BÃ¡n sáº¡ch Backpack.")
	else
		uiStatus("âŒ KhÃ´ng cÃ³ Remote ItemSell")
	end
end

--====================================================
-- âœ… PHáº¦N 5: ÄÃ€O CÃ‚Y
--====================================================
local RemoveEvent = Remotes:FindFirstChild("RemoveItem")

local function gardenHasPlant()
	local plots = workspace:FindFirstChild("Plots")
	if not plots then return false end
	for _, plot in ipairs(plots:GetChildren()) do
		local owner = plot:GetAttribute("Owner")
		if owner and owner:lower() == lp.Name:lower() then
			local plantFolder = plot:FindFirstChild("Plants")
			if plantFolder then
				for _, plant in ipairs(plantFolder:GetChildren()) do
					if baseName(plant.Name) == TARGET_BASE then return true end
				end
			end
		end
	end
	return false
end

local function digAllMyPlants_once()
	if not RemoveEvent then return 0 end
	local plots = workspace:FindFirstChild("Plots")
	if not plots then return 0 end
	local dug = 0
	for _, plot in ipairs(plots:GetChildren()) do
		local owner = plot:GetAttribute("Owner")
		if owner and owner:lower() == lp.Name:lower() then
			local folder = plot:FindFirstChild("Plants")
			if folder then
				for _, plant in ipairs(folder:GetChildren()) do
					if baseName(plant.Name) == TARGET_BASE then
						local basePart = plant:FindFirstChildWhichIsA("BasePart")
						local id = plant:GetAttribute("ID")
						if basePart and id and HRP then
							HRP.CFrame = basePart.CFrame + Vector3.new(0, 3, 0)
							task.wait(0.12)
							RemoveEvent:FireServer(id)
							dug += 1
							task.wait(0.8)
						end
					end
				end
			end
		end
	end
	if dug > 0 then uiStatus(("â› ÄÃ o xong %d cÃ¢y %s"):format(dug, PLANT_NAME)) end
	return dug
end

local function digAllMyPlants_untilEmpty()
	local n = 0
	while gardenHasPlant() do
		n += digAllMyPlants_once()
		task.wait(0.5)
	end
	if n == 0 then uiStatus("âœ… KhÃ´ng cÃ²n cÃ¢y trong vÆ°á»n.") end
end

--====================================================
-- âœ… PHáº¦N 6: GIFT
--====================================================
local GiftEvent = Remotes:FindFirstChild("GiftItem")

local function waitTarget(timeout)
	local t0 = tick()
	repeat
		local target = Players:FindFirstChild(TARGET_PLAYER)
		if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
			return target
		end
		task.wait(1)
	until tick() - t0 > timeout
	return nil
end

local function giftAll_afterTeleportOnce()
	local target = waitTarget(10)
	if not target then
		uiStatus("âš ï¸ KhÃ´ng tÃ¬m tháº¥y ngÆ°á»i nháº­n, chá»...")
		return
	end
	if HRP and target.Character then
		HRP.CFrame = target.Character.HumanoidRootPart.CFrame + Vector3.new(0, 3, 0)
		uiStatus("ğŸš€ Teleport tá»›i " .. TARGET_PLAYER)
		task.wait(1)
	end

	local giftCount = 0
	while stillHasPlant() do
		local tool = findPlantInBackpack() or findPlantOnHand()
		if not tool then break end

		local hum = lp.Character and lp.Character:FindFirstChildOfClass("Humanoid")
		if hum then hum:EquipTool(tool) task.wait(0.4) end

		giftCount += 1
		uiStatus(("ğŸ Gá»­i %s cho %s (láº§n %d)"):format(PLANT_NAME, TARGET_PLAYER, giftCount))
		GiftEvent:FireServer({ Item = tool, ToGift = TARGET_PLAYER })

		-- chá» tool biáº¿n máº¥t (rá»i tay/tÃºi)
		local t0 = tick()
		repeat
			task.wait(0.3)
			if not stillHasPlant() then break end
		until tick() - t0 > 5
		task.wait(3)
	end
	uiStatus(("âœ… Gift xong %d cÃ¢y %s"):format(giftCount, PLANT_NAME))
end

--====================================================
-- âœ… PHáº¦N 7: MAIN (chuá»—i thao tÃ¡c)
--====================================================
local function main()
	uiStatus("ğŸš€ Báº¯t Ä‘áº§u: Unlock â†’ AutoSell â†’ SellAll â†’ ÄÃ o â†’ Gift â†’ Kick")

	unlockAllMatchingPlants()
	setupAutoSell()
	sellAllNow()

	while true do
		if gardenHasPlant() then
			uiStatus("â› ÄÃ o cÃ¢y: " .. PLANT_NAME)
			digAllMyPlants_untilEmpty()
			task.wait(0.5)
		end

		if stillHasPlant() then
			giftAll_afterTeleportOnce()
			task.wait(0.5)
		end

		if not stillHasPlant() and not gardenHasPlant() then
			uiStatus("ğŸ‰ HoÃ n táº¥t â†’ Kick 267")
			lp:Kick("ğŸ‰ ÄÃ£ Ä‘Ã o & gift toÃ n bá»™ (267)")
			break
		end

		task.wait(0.5)
	end
end

--====================================================
-- âœ… PHáº¦N 8: CHáº Y
--====================================================
task.spawn(function()
	task.wait(0.8)
	main()
end)
