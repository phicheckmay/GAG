-- // KenPhysical - Mail UI (White Neon + Safe Optimization + Timer)
local player = game.Players.LocalPlayer
local username = player and player.Name or "Unknown"

-- UI setup
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "KenPhysicalMailUI"
ScreenGui.IgnoreGuiInset = true
ScreenGui.ResetOnSpawn = false

-- Ná»n tráº¯ng
local bg = Instance.new("Frame", ScreenGui)
bg.Size = UDim2.new(1, 0, 1, 0)
bg.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
bg.BorderSizePixel = 0
bg.BackgroundTransparency = 0.05

-- Hiá»‡u á»©ng neon
local function neon(label, color)
    local stroke = Instance.new("UIStroke", label)
    stroke.Thickness = 2
    stroke.Color = color
    stroke.Transparency = 0.4
    local glow = Instance.new("UIGradient", label)
    glow.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(1, color)
    }
    glow.Rotation = 45
end

-- TiÃªu Ä‘á»
local Title = Instance.new("TextLabel", bg)
Title.Size = UDim2.new(1, 0, 0, 120)
Title.Position = UDim2.new(0, 0, 0.20, 0)
Title.BackgroundTransparency = 1
Title.Text = "ğŸ“¬ KenPhysical Mail System - " .. username
Title.TextColor3 = Color3.fromRGB(0, 200, 255)
Title.Font = Enum.Font.GothamBold
Title.TextScaled = true
neon(Title, Color3.fromRGB(0, 200, 255))

-- Gems Label
local GemsLabel = Instance.new("TextLabel", bg)
GemsLabel.Size = UDim2.new(1, 0, 0, 100)
GemsLabel.Position = UDim2.new(0, 0, 0.45, 0)
GemsLabel.BackgroundTransparency = 1
GemsLabel.Text = "ğŸ’ Gems hiá»‡n cÃ³: ..."
GemsLabel.TextColor3 = Color3.fromRGB(0, 150, 255)
GemsLabel.Font = Enum.Font.GothamBold
GemsLabel.TextScaled = true
neon(GemsLabel, Color3.fromRGB(0, 150, 255))

-- Online timer
local OnlineLabel = Instance.new("TextLabel", bg)
OnlineLabel.Size = UDim2.new(1, 0, 0, 70)
OnlineLabel.Position = UDim2.new(0, 0, 0.70, 0)
OnlineLabel.BackgroundTransparency = 1
OnlineLabel.Text = "ğŸ•“ Online: 00:00"
OnlineLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
OnlineLabel.Font = Enum.Font.GothamSemibold
OnlineLabel.TextScaled = true
neon(OnlineLabel, Color3.fromRGB(0, 0, 0))

local startTime = tick()
task.spawn(function()
    while task.wait(1) do
        local elapsed = math.floor(tick() - startTime)
        local mins = math.floor(elapsed / 60)
        local secs = elapsed % 60
        OnlineLabel.Text = string.format("ğŸ•“ Online: %02d:%02d", mins, secs)
    end
end)

-- Format number
local function formatNumber(n)
    if n >= 1e12 then
        return string.format("%.3fT", n / 1e12)
    elseif n >= 1e9 then
        return string.format("%.3fB", n / 1e9)
    elseif n >= 1e6 then
        return string.format("%.3fM", n / 1e6)
    elseif n >= 1e3 then
        return string.format("%.3fK", n / 1e3)
    else
        return string.format("%.3f", n)
    end
end

-- Safe getDiamonds
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local SaveFunction = require(ReplicatedStorage.Library.Client.Save).Get
local CurrencyCmds = require(ReplicatedStorage.Library.Client.CurrencyCmds)
local Items = require(ReplicatedStorage.Library.Items)

local function getDiamondsSafe()
    local ok, amt = pcall(function()
        return CurrencyCmds.Get("Diamonds")
    end)
    if ok and type(amt) == "number" then return amt end
    local save = SaveFunction and SaveFunction()
    if save and save.Inventory and save.Inventory.Currency then
        for _, cur in pairs(save.Inventory.Currency) do
            if cur.id == "Diamonds" and type(cur._am) == "number" then
                return cur._am
            end
        end
    end
    local entry = Items.Currency("Diamonds"):FindAny()[1]
    if entry and entry._data and type(entry._data._am) == "number" then
        return entry._data._am
    end
    return 0
end

-- Update Gems má»—i 5s
local RunService = game:GetService("RunService")
local gems = 0

task.spawn(function()
	repeat task.wait(0.5) until pcall(function() return SaveFunction() ~= nil end)
	while task.wait(5) do
		gems = getDiamondsSafe()
	end
end)

RunService.RenderStepped:Connect(function()
	GemsLabel.Text = "ğŸ’ Gems hiá»‡n cÃ³: " .. formatNumber(gems)
end)

-- Toggle báº±ng H
local UIS = game:GetService("UserInputService")
local visible = true
UIS.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == Enum.KeyCode.H then
        visible = not visible
        bg.Visible = visible
    end
end)

print("[âœ…] KenPhysical Mail UI loaded (Toggle = H)")

-----------------------------------------------------
-- MAIL SCRIPT (Gá»­i luÃ¢n phiÃªn + Giá»¯ láº¡i gems)
-----------------------------------------------------
-- ğŸ”¥ DANH SÃCH NGÆ¯á»œI NHáº¬N (ThÃªm nhiá»u ngÆ°á»i vÃ o Ä‘Ã¢y)
local PlayerToSend = {"JackOmegaQueen", "L3vi_Giga75", "Kaylee_Thunder16"}
local GemTreshold = 2000000     -- Báº¯t Ä‘áº§u gá»­i khi >= 2M gems
local KeepGems = 1000000        -- LuÃ´n giá»¯ láº¡i 1M gems
local SendOnlyGems = false
local MailClaimInterval = 60

local RunService = game:GetService("RunService")
local LightningService = game:GetService("Lighting")
local LocalPlayer = game.Players.LocalPlayer
local NetworkPath = ReplicatedStorage.Network
local NetworkSource = require(ReplicatedStorage.Library.Client.Network)
local AlreadySend = {}

-- ğŸ”¥ Há»† THá»NG LUÃ‚N PHIÃŠN NGÆ¯á»œI NHáº¬N
local currentRecipientIndex = 1
local recipientFailCount = {}

-- Khá»Ÿi táº¡o fail counter
for _, name in ipairs(PlayerToSend) do
    recipientFailCount[name] = 0
end

local function getNextRecipient()
    local attempts = 0
    
    while attempts < #PlayerToSend do
        local recipient = PlayerToSend[currentRecipientIndex]
        
        -- Náº¿u ngÆ°á»i nÃ y fail dÆ°á»›i 3 láº§n, dÃ¹ng ngÆ°á»i nÃ y
        if recipientFailCount[recipient] < 3 then
            return recipient, currentRecipientIndex
        end
        
        -- Chuyá»ƒn sang ngÆ°á»i tiáº¿p theo
        currentRecipientIndex = currentRecipientIndex % #PlayerToSend + 1
        attempts = attempts + 1
    end
    
    -- Reset náº¿u táº¥t cáº£ Ä‘á»u fail
    for name, _ in pairs(recipientFailCount) do
        recipientFailCount[name] = 0
    end
    currentRecipientIndex = 1
    return PlayerToSend[1], 1
end

-- Optimization an toÃ n
local function OptimizationSafe()
    local RunService = game:GetService("RunService")
    local Lighting = game:GetService("Lighting")

    pcall(function() RunService:Set3dRenderingEnabled(true) end)
    pcall(function() settings().Rendering.QualityLevel = Enum.QualityLevel.Level01 end)

    for _, effect in pairs(Lighting:GetChildren()) do
        if effect:IsA("BloomEffect") 
        or effect:IsA("SunRaysEffect") 
        or effect:IsA("DepthOfFieldEffect")
        or effect:IsA("BlurEffect")
        or effect:IsA("ColorCorrectionEffect") then
            effect.Enabled = false
        elseif effect:IsA("Atmosphere") then
            effect.Density = 0
            effect.Haze = 0
            effect.Color = Color3.new(1, 1, 1)
            effect.Decay = Color3.new(1, 1, 1)
        end
    end

    for _, obj in ipairs(workspace:GetDescendants()) do
        if workspace:FindFirstChild("__THINGS") and obj:IsDescendantOf(workspace.__THINGS) then
            continue
        end
        if obj:IsA("ParticleEmitter") or obj:IsA("Trail") 
        or obj:IsA("Smoke") or obj:IsA("Fire") or obj:IsA("Sparkles") then
            obj.Enabled = false
        end
    end
end

local function GetData()
	local Data = SaveFunction()
	if Data then
		local copy = {}
		for k,v in pairs(Data) do copy[k]=v end
		return copy
	end
	return nil
end

local function mailcost()
	local call = SaveFunction()
	local defcost = 20000
	if not call then return defcost end
	local MailIsReset = (call.MailboxResetTime and call.MailboxResetTime - workspace:GetServerTimeNow())
	local TotalMailsForSession = call.MailboxSendsSinceReset or 0
	if not MailIsReset or MailIsReset <= 0 then return defcost end
	if TotalMailsForSession >= 14 then return 5000000 end
	return math.ceil(defcost * math.pow(1.5, TotalMailsForSession))
end

local function genMessage()
	return "free gift " .. tostring(math.random(1,100))
end

-- ğŸ”¥ HÃ€M Gá»¬I MAIL Vá»šI Xá»¬ LÃ Lá»–I VÃ€ LUÃ‚N PHIÃŠN
local function SendMail(category, id, amount)
    local maxRetries = #PlayerToSend
    local attempts = 0
    
    print("\nğŸš€ Báº®T Äáº¦U Gá»¬I MAIL")
    print("ğŸ“¦ Category:", category)
    print("ğŸ’¯ Amount:", amount)
    
    while attempts < maxRetries do
        local recipient, index = getNextRecipient()
        
        print("\nğŸ‘¤ Thá»­ gá»­i cho:", recipient, "(láº§n", attempts + 1, "/", maxRetries, ")")
        print("ğŸ“Š Fail count:", recipientFailCount[recipient])
        
        local success, msg = NetworkPath["Mailbox: Send"]:InvokeServer(
            recipient,  -- Gá»­i cho 1 ngÆ°á»i
            genMessage(), 
            category, 
            id, 
            amount or 1
        )
        
        if success then
            print("âœ… Gá»¬I THÃ€NH CÃ”NG CHO:", recipient)
            recipientFailCount[recipient] = 0
            currentRecipientIndex = currentRecipientIndex % #PlayerToSend + 1
            return success, msg
        else
            warn("âŒ Gá»¬I THáº¤T Báº I CHO:", recipient)
            warn("   LÃ½ do:", msg or "Unknown")
            recipientFailCount[recipient] = recipientFailCount[recipient] + 1
            currentRecipientIndex = currentRecipientIndex % #PlayerToSend + 1
            attempts = attempts + 1
            
            -- Náº¿u mailbox Ä‘áº§y, thá»­ ngÆ°á»i khÃ¡c ngay
            if msg and (msg:find("space") or msg:find("full")) then
                warn("   â†’ Mailbox Ä‘áº§y, chuyá»ƒn ngÆ°á»i khÃ¡c...")
                task.wait(0.3)
                continue
            end
            
            task.wait(0.5)
        end
    end
    
    warn("âš ï¸ ÄÃƒ THá»¬ Gá»¬I CHO Táº¤T Cáº¢", maxRetries, "NGÆ¯á»œI NHÆ¯NG Äá»€U THáº¤T Báº I!")
    return false, "All recipients failed"
end

local function CheckInventory()
	local Data = GetData()
	local Gems = Items.Currency("Diamonds"):FindAny()[1]
	local GemsId = Gems._uid
	local GemsAmount = getDiamondsSafe()
	local MailCost = mailcost()
	
	local availableToSend = GemsAmount - KeepGems - MailCost
	
	print("\nğŸ’ Gems hiá»‡n cÃ³:", GemsAmount)
	print("ğŸ”’ Giá»¯ láº¡i:", KeepGems)
	print("ğŸ’° Mail Cost:", MailCost)
	print("ğŸ“¤ CÃ³ thá»ƒ gá»­i:", availableToSend)

	-- Gá»¬I GEMS
	if GemsAmount >= GemTreshold and availableToSend > 0 then
		print("ğŸ“¬ Äang gá»­i", availableToSend, "gems...")
		local sus, ms = SendMail("Currency", GemsId, availableToSend)
		
		if not sus then
			warn("âŒ Lá»—i gá»­i gems:", ms)
			if ms and ms == "Couldn't remove this item from your inventory!" then
				task.wait(.25)
				local retryAmount = math.max(0, availableToSend - 1000000)
				if retryAmount > 0 then
					print("ğŸ”„ Thá»­ láº¡i vá»›i", retryAmount, "gems...")
					SendMail("Currency", GemsId, retryAmount)
				end
			end
		end
	else
		print("â¸ï¸ KhÃ´ng gá»­i gems (chÆ°a Ä‘á»§ threshold hoáº·c gems)")
	end

	-- Gá»¬I PETS
	if not SendOnlyGems and Data and Data.Inventory then
		print("\nğŸ¾ Kiá»ƒm tra pets...")
		local petCount = 0
		
		for i,v in pairs(Data.Inventory.Pet or {}) do
			if string.find(v.id:lower(), "huge") and not AlreadySend[i] then
				petCount = petCount + 1
				
				if v._lk then 
					NetworkPath["Locking_SetLocked"]:InvokeServer(i, false) 
					task.wait(.25) 
				end
				
				print("ğŸ“¦ Äang gá»­i pet:", v.id)
				local susses, ms = SendMail("Pet", i, 1)
				
				if susses then 
					print("âœ… ÄÃ£ gá»­i pet:", v.id)
					AlreadySend[i] = true 
					task.wait(.25) 
				else
					warn("âŒ Lá»—i gá»­i pet:", ms)
					if ms and ms == "They don't have enough space!" then 
						warn("âš ï¸ Táº¥t cáº£ ngÆ°á»i nháº­n Ä‘á»u háº¿t chá»—!")
						break 
					end
				end
			end
		end
		
		if petCount == 0 then
			print("ğŸ“­ KhÃ´ng cÃ³ huge pet Ä‘á»ƒ gá»­i")
		end
	end
end

-- Chá»‘ng AFK
task.spawn(function()
    pcall(function()
        game:GetService("ReplicatedStorage").Network["Idle Tracking: Stop Timer"]:FireServer()
    end)
    task.wait(0.2)

    local VirtualInputManager = game:GetService("VirtualInputManager")
    while task.wait(300) do
        pcall(function()
            VirtualInputManager:SendKeyEvent(true, "Space", false, game)
            task.wait(0.2)
            VirtualInputManager:SendKeyEvent(false, "Space", false, game)
        end)
    end
end)

OptimizationSafe()

task.spawn(function()
	while true do
		NetworkPath["Mailbox: Claim All"]:InvokeServer()
		task.wait(MailClaimInterval)
	end
end)

task.spawn(function()
	while true do
		pcall(CheckInventory)
		task.wait(10)
	end
end)
