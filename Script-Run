repeat task.wait() until game:IsLoaded()

----------------------------------------------------------
-- üîß CONFIG (quan tr·ªçng ‚Äì b·∫°n ch·ªânh ·ªü ƒë√¢y)
----------------------------------------------------------

-- ‚úî Danh s√°ch c√¢y gi·ªØ l·∫°i (kh√¥ng ƒë√†o)
getgenv().KEEP_LIST = {
    ["Mango"] = true,
    ["Starfruit"] = true,
    ["King Limone"] = true,
}

-- ‚úî Danh s√°ch Seed ƒë∆∞·ª£c ph√©p tr·ªìng (∆∞u ti√™n t·ª´ tr√™n xu·ªëng)
getgenv().SEED_PLANT_LIST = {
    "Mango",
    "Starfruit",
    "King Limone"
}

-- ‚úî C√≥ t·ª± Sell All kh√¥ng?
getgenv().ENABLE_AUTO_SELL_ALL = true

-- ‚úî Delay gi·ªØa c√°c v√≤ng auto
getgenv().CYCLE_DELAY = 3



----------------------------------------------------------
-- üîå SERVICE + MODULES
----------------------------------------------------------

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer
local HRP = LP.Character and LP.Character:WaitForChild("HumanoidRootPart")
local DataF = require(RS.PlayerData).GetData

local plotId = LP:GetAttribute("Plot")
local plot = workspace.Plots:WaitForChild(plotId)
local GrassTable = plot.Rows

local RemoveEvent = RS.Remotes.RemoveItem
local PlaceItem  = RS.Remotes.PlaceItem
local SellRemote = RS.Remotes.ItemSell



----------------------------------------------------------
-- üü¢ B1. ANTI AFK
----------------------------------------------------------

task.spawn(function()
    pcall(function()
        RS.Network["Idle Tracking: Stop Timer"]:FireServer()
    end)
    local VIM = game:GetService("VirtualInputManager")
    while task.wait() do
        VIM:SendKeyEvent(true,"Space",false,game)
        task.wait(.15)
        VIM:SendKeyEvent(false,"Space",false,game)
        task.wait(300)
    end
end)



----------------------------------------------------------
-- üü° B2. UNLOCK TIM
----------------------------------------------------------

task.spawn(function()
    local favRemote = RS.Remotes.FavoriteItem
    local FavoritesTable
    for _, v in ipairs(getgc(true)) do
        if typeof(v) == "table" and rawget(v,"Favorites") then
            FavoritesTable = rawget(v,"Favorites")
            break
        end
    end
    if FavoritesTable then
        for uuid,_ in pairs(FavoritesTable) do
            favRemote:FireServer(uuid)
            task.wait(.05)
        end
    end
    print("üíõ Unlock tim ho√†n t·∫•t")
end)



----------------------------------------------------------
-- üî• B3 + B4. AUTO SELL ALL
----------------------------------------------------------

task.spawn(function()
    while getgenv().ENABLE_AUTO_SELL_ALL do
        SellRemote:FireServer(nil,nil,true)
        print("üóëÔ∏è SELL ALL DONE")
        task.wait(30)
    end
end)



----------------------------------------------------------
-- üìå HELPER FUNCTIONS (QUAN TR·ªåNG)
----------------------------------------------------------

-- ‚úî L·∫•y PlayerData
local function GetData()
    local d = DataF()
    return d and d.Data or nil
end

-- ‚úî Ph√¢n bi·ªát H·∫†T trong t√∫i (Tool Seed)
local function IsSeed(tool)
    return tool:IsA("Tool")
       and tool.Name:match("Seed$")
       and tool:GetAttribute("ID") ~= nil
end

-- ‚úî Ph√¢n bi·ªát C√ÇY trong v∆∞·ªùn
local function IsPlant(model)
    return model:IsA("Model")
       and model.Parent
       and model.Parent.Name == "Plants"
       and model:GetAttribute("ID") ~= nil
end

local function baseName(str)
    return tostring(str or "")
        :gsub("%b[]","")
        :gsub("%b()","")
        :gsub("%s+"," ")
        :gsub("^%s+","")
        :gsub("%s+$","")
end

-- ‚úî L·∫•y SeedID t·ª´ PlayerData
local function GetSeedId(seedName)
    local data = GetData()
    if not data or not data.Plants then return nil end
    for id, info in pairs(data.Plants) do
        if info.Name == seedName then
            return id
        end
    end
    return nil
end

-- ‚úî T√¨m tile tr·ªëng
local function GetEmptyTile()
    for _, row in ipairs(GrassTable:GetChildren()) do
        if row:GetAttribute("Enabled") then
            for _, grass in ipairs(row.Grass:GetChildren()) do
                if not grass:GetAttribute("Occupied") then
                    return grass
                end
            end
        end
    end
    return nil
end

-- ‚úî Equip seed (ch·ªëng l·ªói tool ƒëang c·∫ßm)
local function EquipSeed(id)
    local char = LP.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return false end

    -- ƒëang c·∫ßm ƒë√∫ng seed r·ªìi ‚Üí OK
    for _, tool in ipairs(char:GetChildren()) do
        if IsSeed(tool) and tool:GetAttribute("ID") == id then
            return true
        end
    end

    -- t√¨m trong Backpack
    for _, tool in ipairs(LP.Backpack:GetChildren()) do
        if IsSeed(tool) and tool:GetAttribute("ID") == id then
            hum:UnequipTools()
            task.wait(.05)
            hum:EquipTool(tool)
            task.wait(.1)
            return true
        end
    end

    return false
end



----------------------------------------------------------
-- ‚õèÔ∏è B5. ƒê√ÄO C√ÇY (tr·ª´ c√¢y trong KEEP_LIST)
----------------------------------------------------------

local function DigAll_NotInKeepList()
    local plantsFolder = plot:FindFirstChild("Plants")
    if not plantsFolder then return 0 end

    local dug = 0

    for _, plant in ipairs(plantsFolder:GetChildren()) do
        if IsPlant(plant) then
            local cleanName = baseName(plant.Name)

            if not getgenv().KEEP_LIST[cleanName] then
                local id = plant:GetAttribute("ID")
                local bp = plant:FindFirstChildWhichIsA("BasePart")

                if id and bp then
                    HRP.CFrame = bp.CFrame + Vector3.new(0,3,0)
                    task.wait(.1)
                    RemoveEvent:FireServer(id)
                    dug += 1
                    print("‚õè ƒê√†o:", cleanName)
                    task.wait(.2)
                end
            else
                print("üü¢ Gi·ªØ l·∫°i:", cleanName)
            end
        end
    end

    return dug
end



----------------------------------------------------------
-- üå± B6. TR·ªíNG SEED THEO LIST
----------------------------------------------------------

local function PlantOne(seedName)
    local seedID = GetSeedId(seedName)
    if not seedID then return false end

    if not EquipSeed(seedID) then
        print("‚ö† Kh√¥ng equip ƒë∆∞·ª£c:", seedName)
        return false
    end

    local tile = GetEmptyTile()
    if not tile then
        print("‚ö† H·∫øt √¥ tr·ªëng")
        return false
    end

    PlaceItem:FireServer({
        ID = seedID,
        CFrame = CFrame.new(tile.Position),
        Item = seedName,
        Floor = tile
    })

    print("üå± Tr·ªìng:", seedName)
    task.wait(.3)
    return true
end



----------------------------------------------------------
-- üîÅ B7. AUTO LOOP FULL CYCLE
----------------------------------------------------------

task.spawn(function()
    while task.wait(getgenv().CYCLE_DELAY) do
        print("======== üîÅ B·∫ÆT ƒê·∫¶U CHU TR√åNH =========")

        DigAll_NotInKeepList()

        for _, seed in ipairs(getgenv().SEED_PLANT_LIST) do
            while PlantOne(seed) do
                task.wait(.2)
            end
        end

        print("======== üîÅ K·∫æT TH√öC CHU TR√åNH =========")
    end
end)
