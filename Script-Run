repeat task.wait() until game:IsLoaded()

----------------------------------------------------------
-- üîß CONFIG
----------------------------------------------------------

getgenv().KEEP_LIST = {
    ["Mango"] = true,
    ["Starfruit"] = true,
    ["King Limone"] = true,
}

getgenv().SEED_PLANT_LIST = {
    "Mango",
    "Starfruit",
    "King Limone",
    "Shroombino"
}

-- AutoSell ALL + SellAll PET
getgenv().ENABLE_AUTO_SELL_ALL = true
getgenv().ENABLE_SELL_ALL_PET   = true

getgenv().CYCLE_DELAY = 3


----------------------------------------------------------
-- üî• WAIT FOR GAME
----------------------------------------------------------

repeat task.wait() until game:IsLoaded()
print("‚è≥ ƒê·ª£i 10s ·ªïn ƒë·ªãnh...")
task.wait(10)


----------------------------------------------------------
-- üîå SERVICES
----------------------------------------------------------

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local LP = Players.LocalPlayer
local HRP = LP.Character and LP.Character:WaitForChild("HumanoidRootPart")
local DataF = require(RS.PlayerData).GetData

local plotId = LP:GetAttribute("Plot")
local plot = workspace.Plots:WaitForChild(plotId)
local GrassTable = plot.Rows

local RemoveEvent = RS.Remotes.RemoveItem
local PlaceItem  = RS.Remotes.PlaceItem
local SellRemote = RS.Remotes.ItemSell


----------------------------------------------------------
-- üü¢ B1 ANTI AFK
----------------------------------------------------------

task.spawn(function()
    pcall(function()
        RS.Network["Idle Tracking: Stop Timer"]:FireServer()
    end)
    local VIM = game:GetService("VirtualInputManager")
    while task.wait() do
        VIM:SendKeyEvent(true,"Space",false,game)
        task.wait(.15)
        VIM:SendKeyEvent(false,"Space",false,game)
        task.wait(300)
    end
end)


----------------------------------------------------------
-- üü° B2 UNLOCK HEARTS
----------------------------------------------------------

task.spawn(function()
    local favRemote = RS.Remotes.FavoriteItem
    local FavoritesTable
    
    for _, v in ipairs(getgc(true)) do
        if typeof(v)=="table" and rawget(v,"Favorites") then
            FavoritesTable = v.Favorites
            break
        end
    end
    
    if FavoritesTable then
        for uuid,_ in pairs(FavoritesTable) do
            favRemote:FireServer(uuid)
            task.wait(.05)
        end
    end

    print("üíõ Unlock tim xong")
end)


----------------------------------------------------------
-- üî• B3 SET AUTO SELL ALL
----------------------------------------------------------

task.spawn(function()
    if not getgenv().ENABLE_AUTO_SELL_ALL then return end
    
    local AutoSellTable = nil
    local AutoSellRemote = RS.Remotes.AutoSell

    while not AutoSellTable do
        for _,v in ipairs(getgc(true)) do
            if typeof(v)=="table" and rawget(v,"AutoSell") then
                AutoSellTable = v.AutoSell
                break
            end
        end
        task.wait(.1)
    end
    
    print("‚úÖ AutoSell Table Loaded")

    local Desired = {
        Normal=true, Gold=true, Diamond=true, Frozen=true,
        Ruby=true, Neon=true, UpsideDown=true, Rainbow=true,
        Dailies=true, Bosses=true, Rare=true, Epic=true,
        Legendary=true, Mythic=true, Godly=true, Secret=true,
    }

    local function isOn(r)
        local v = AutoSellTable[r]
        return v == true or v == 1
    end

    local function toggle(r, want)
        for _=1,5 do
            if isOn(r)==want then return end
            AutoSellRemote:FireServer(r)
            task.wait(.1)
        end
    end

    for rarity, want in pairs(Desired) do
        toggle(rarity, want)
        print("‚öôÔ∏è AutoSell:", rarity, "=", want and "GRAY")
        task.wait(.05)
    end

    print("üéØ AUTO SELL ALL DONE")
end)


----------------------------------------------------------
-- üî• B4 SELL ALL PET (Brainrots)
----------------------------------------------------------

task.spawn(function()
    if not getgenv().ENABLE_SELL_ALL_PET then return end

    while task.wait(3) do
        SellRemote:FireServer(nil, nil, true)
        print("üí• SELL ALL PET DONE")
    end
end)


----------------------------------------------------------
-- üìå HELPERS
----------------------------------------------------------

local function GetData()
    local d = DataF()
    return d and d.Data or nil
end

local function IsSeed(tool)
    return tool:IsA("Tool") and tool.Name:match("Seed")
end

local function IsPlant(model)
    return model:IsA("Model")
       and model.Parent
       and model.Parent.Name == "Plants"
       and model:GetAttribute("ID") ~= nil
end

local function baseName(str)
    str = tostring(str)

    -- b·ªè ph·∫ßn trong [ ] v√† ( )
    str = str:gsub("%b[]", "")
    str = str:gsub("%b()", "")

    -- b·ªè s·ªë level (III, II, IV), ho·∫∑c s·ªë 1-9
    str = str:gsub("%s+%u%u%u?$", "")  -- b·ªè III, II, IV...
    str = str:gsub("%s+%d+$", "")      -- b·ªè s·ªë 1,2,3,...

    -- xo√° kho·∫£ng tr·∫Øng th·ª´a
    str = str:gsub("%s+", " ")
             :gsub("^%s+", "")
             :gsub("%s+$", "")

    return str
end


local function GetEmptyTile()
    for _,row in ipairs(GrassTable:GetChildren()) do
        if row:GetAttribute("Enabled") then
            for _,grass in ipairs(row.Grass:GetChildren()) do
                if not grass:GetAttribute("Occupied") then
                    return grass
                end
            end
        end
    end
    return nil
end


----------------------------------------------------------
-- üå± FIX FULL SEED EQUIP (CHECK BACKPACK + CHARACTER)
----------------------------------------------------------

local BP = LP:WaitForChild("Backpack")

local function cleanSeedName(str)
    return tostring(str)
        :gsub("%b[]",""):gsub("%b()","")
        :gsub("%s+"," "):gsub("^%s+",""):gsub("%s+$","")
end

-- T√åM SEED TRONG CHARACTER + BACKPACK
local function findSeed(seedName)
    local expected = seedName .. " Seed"
    local char = LP.Character

    -- 1Ô∏è‚É£ Ki·ªÉm tra seed ƒëang C·∫¶M TR√äN TAY
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            if tool:IsA("Tool") and cleanSeedName(tool.Name) == expected then
                return tool
            end
        end
    end

    -- 2Ô∏è‚É£ Ki·ªÉm tra trong Backpack
    for _, tool in ipairs(BP:GetChildren()) do
        if tool:IsA("Tool") and cleanSeedName(tool.Name) == expected then
            return tool
        end
    end

    return nil
end

-- EQUIP SEED CHU·∫®N 100%
local function equipSeed(seedName)
    local expected = seedName .. " Seed"
    local char = LP.Character or LP.CharacterAdded:Wait()
    local hum = char:WaitForChild("Humanoid")

    -- 1Ô∏è‚É£ N·∫øu ƒëang c·∫ßm ƒë√∫ng seed ‚Üí OK
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and cleanSeedName(tool.Name) == expected then
            return true
        end
    end

    -- 2Ô∏è‚É£ T√¨m seed
    local tool = findSeed(seedName)
    if not tool then
        warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y:", expected)
        return false
    end

    hum:UnequipTools()
    task.wait(.05)
    hum:EquipTool(tool)

    print("üå± Equipped:", expected)
    return true
end


----------------------------------------------------------
-- üå± TR·ªíNG 1 H·∫†T (FIX L·ªñI SEED CU·ªêI KH√îNG TR·ªíNG)
----------------------------------------------------------

function PlantOne(seedName)
    if not equipSeed(seedName) then return false end

    local tile = GetEmptyTile()
    if not tile then
        print("‚ö† H·∫øt √¥ tr·ªëng")
        return false
    end

    PlaceItem:FireServer({
        Item = seedName,
        CFrame = CFrame.new(tile.Position),
        Floor = tile
    })

    print("üå± Tr·ªìng:", seedName)
    task.wait(.3)
    return true
end


----------------------------------------------------------
-- ‚õèÔ∏è B5 DIG
----------------------------------------------------------

local function DigAll_NotInKeepList()
    local plantsFolder = plot:FindFirstChild("Plants")
    if not plantsFolder then return end

    for _,plant in ipairs(plantsFolder:GetChildren()) do
        if IsPlant(plant) then
            local clean = baseName(plant.Name)

            if not getgenv().KEEP_LIST[clean] then
                local id = plant:GetAttribute("ID")
                local bp = plant:FindFirstChildWhichIsA("BasePart")

                if id and bp then
                    HRP.CFrame = bp.CFrame + Vector3.new(0,3,0)
                    task.wait(.1)
                    RemoveEvent:FireServer(id)
                    print("‚õè ƒê√†o:", clean)
                    task.wait(.2)
                end
            else
                print("üü¢ Gi·ªØ l·∫°i:", clean)
            end
        end
    end
end


----------------------------------------------------------
-- üîÅ B7 LOOP
----------------------------------------------------------

task.spawn(function()
    while task.wait(getgenv().CYCLE_DELAY) do

        print("======== üîÅ B·∫ÆT ƒê·∫¶U =========")

        DigAll_NotInKeepList()

        for _,seed in ipairs(getgenv().SEED_PLANT_LIST) do
            while PlantOne(seed) do task.wait(.2) end
        end

        print("======== üîÅ K·∫æT TH√öC =========")
    end
end)
